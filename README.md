# Point Cloud Cropper

Interactive point-cloud cropping web app built with three.js, plus a CLI tool for offline cropping.

The app lets you:

- Load `.ply` point clouds via drag & drop
- Adjust a 6-face axis-aligned crop box (with draggable planes)
- Add & rotate custom infinite planes to select a polyhedral region
- Use a **Magic Volume** flood-fill to select a connected component around a seed point
- Export the cropped points to a new `.ply`
- Save/load presets and URLs that encode all parameters

> Live (GitHub Pages) URL once enabled:  
> `https://refracta.github.io/point-cloud-cropper/index.html`

If GitHub Pages is not enabled for this repo yet, you can still open `index.html` directly in a local browser or host it via any static file server.

---

## Project Structure

- `index.html`  
  Main single-page web app. Contains the three.js viewer, UI, URL / preset handling, cropping logic, custom planes, and Magic Volume.

- `utils/crop_ply.py`  
  CLI script that applies the same crop logic (crop box, invert, custom planes, Magic Volume seed/preset) to `.ply` files on the command line.

- `presets/`  
  Example `preset.json` files generated by the web app.

---

## Running the Web App

### Option 1 – GitHub Pages

1. In the GitHub repository settings, enable **GitHub Pages** with:
   - Source: `Deploy from a branch`
   - Branch: `master` (or `main`), folder `/ (root)`
2. Wait for GitHub to build the static site.
3. Open:
   ```text
   https://refracta.github.io/point-cloud-cropper/index.html
   ```

### Option 2 – Local file or static server

#### Open directly

- Simply double-click `index.html` to open in your browser.  
  (Some browsers may restrict `file://` for certain APIs; if that happens, use a local server.)

#### Using a minimal static server (Python)

```bash
cd /path/to/point-cloud-cropper
python -m http.server 8000
```

Then open:

```text
http://localhost:8000/index.html
```

---

## Web UI Usage

### Loading a PLY

- Drag & drop a `.ply` file onto the left viewport.
- The viewer will:
  - Center and frame the point cloud
  - Compute the bounding box
  - Initialize the crop box to tightly contain all points

Viewport controls:

- **Left drag**: orbit  
- **Right drag**: pan  
- **Mouse wheel**: zoom

### Basic Crop Box

Right panel → **Crop Box**

- Six numeric fields: `X/Y/Z Min/Max`  
  - Edit to change the axis-aligned crop box.
- `Invert Crop`  
  - OFF: keep points _inside_ the box  
  - ON: keep points _outside_ the box
- `Show Crop Box`  
  - Toggles visibility and interactivity of the six crop planes in the viewport.
- `Reset to full extent`  
  - Resets the crop box to the full point-cloud bounding box.

You can also click a crop plane in the viewport (when `Show Crop Box` is on) and drag it to adjust the corresponding boundary.

### Custom Planes

Right panel → **Custom Planes**

- `Show All Planes`  
  - Globally show/hide all custom planes.
- `Add Plane`  
  - Adds a new custom infinite plane.
- `Clear All`  
  - Removes all custom planes.
- For each plane row:
  - `Plane N` label with a `Show` checkbox  
    - Controls visibility of that specific plane (and whether it can be clicked).
  - `Yaw` and `Pitch` numeric inputs  
    - Control plane orientation (in degrees).
  - `X` button  
    - Removes that plane.

In the viewport:

- Click a custom plane to select it.
- Use:
  - `T` – translate mode (move origin point inside crop box)
  - `R` – rotate mode (change orientation)

#### Smallest region and invert behavior

When custom planes are present:

- Crop box interior is partitioned into regions by custom planes.
- The app picks the region that:
  - Intersects the most custom planes (by area),  
  - Ties broken by the region with more points.
- That region is:
  - **Highlighted** as a clipped polyhedral volume.
  - Used as the “selected region” for cropping:
    - Invert OFF: keep only points in this region.
    - Invert ON: keep all points except this region.

### Magic Volume

Right panel → **Magic Volume**

- `Magic Point Length`  
  - Distance threshold (in the same units as the point cloud).
  - Used as the radius for flood-fill around a seed point.
- `Magic Group Points`  
  - Shows how many points are currently in the Magic Volume group and an approximate percentage of total points while the job is running.

In the viewport:

- **Shift + click** on the point cloud:
  - Picks the point closest to the mouse as a seed index.
  - Performs a BFS flood-fill:
    - All points within `Magic Point Length` of the current frontier are added, and the process repeats until no new neighbors qualify.
  - The result is a connected Magic Volume group in point space.

During BFS:

- The job runs incrementally in the render loop to avoid freezing the UI.
- `Magic Group Points` shows:  
  `visited_count / total_points (percent%)`

After BFS completes:

- The group is visualized as a yellow AABB box.
- The crop box is updated to that AABB.
- When exporting:
  - If Magic Volume is active, **only the Magic Volume group** is used to decide which points to keep:
    - Invert OFF: keep group points only.
    - Invert ON: keep all points except group points.
  - Crop box and custom planes are ignored for the final cropping decision when Magic Volume is active.

Magic Volume state is encoded into:

- URL: `ml` (Magic Point Length), `ms` (seed index)
- `preset.json`: `magicLength`, `magicSeedIndex`

---

## URL Parameters

The app keeps the current state in the URL query so you can share links.

Key parameters:

- `ps` – `Point Size`
- `xmin`, `xmax`, `ymin`, `ymax`, `zmin`, `zmax` – crop box bounds
- `inv` – `Invert Crop` (1/0)
- `cb` – `Show Crop Box` (1/0)
- `cps` – `Show All Planes` for custom planes (1/0)
- `cpYaw`, `cpPitch` – per-plane orientation
- `cpPx`, `cpPy`, `cpPz` – per-plane origin point
- `cpVis` – per-plane visibility mask (1/0)
- `ml` – Magic Point Length
- `ms` – Magic Volume seed point index

Note: the URL does **not** embed the point-cloud data itself. The receiver must load the same `.ply` for the parameters to reproduce the same view and cropping.

---

## Presets

Using the **Export → preset.json** button:

- Downloads a `preset.json` in the following shape (simplified):

```json
{
  "version": 1,
  "sourceFile": "example.ply",
  "pointSize": 1.5,
  "invertCrop": false,
  "showCropBox": true,
  "magicLength": 0.05,
  "magicSeedIndex": 12345,
  "crop": {
    "xmin": -1.0,
    "xmax": 1.0,
    "ymin": -0.5,
    "ymax": 0.5,
    "zmin": 0.0,
    "zmax": 2.0
  },
  "customPlanes": [
    { "yaw": 10, "pitch": 0, "px": 0.0, "py": 0.0, "pz": 0.0, "visible": true }
  ],
  "sourceBBox": {
    "min": { "x": -2.0, "y": -1.0, "z": -1.0 },
    "max": { "x": 2.0, "y": 1.0, "z": 3.0 }
  }
}
```

To reuse a preset:

1. Load the same `.ply` in the web app.
2. Load or re-encode parameters from the preset into the URL.
3. The app will automatically apply crop/custom-planes/Magic Volume if `ms`/`magicSeedIndex` is set.

---

## CLI Usage (`utils/crop_ply.py`)

The CLI script can apply the same cropping rules as the web app to a `.ply` file on disk.

### Basic usage

```bash
python utils/crop_ply.py --ply input.ply --preset presets/example_preset.json
```

Options:

- `--ply` – input `.ply` path
- `--preset` – `preset.json` path generated by the web app
- `--out` – optional output path  
  - If omitted, the script writes `cropped_<input_basename>.ply` next to the input file.

### Behavior

The script:

1. Parses the preset:
   - Crop box: `crop.xmin..zmax`
   - `invertCrop`
   - `customPlanes[]` (`yaw`, `pitch`, `px`, `py`, `pz`, `visible`)
2. Reads the PLY header and vertex data (ASCII or binary little-endian).
3. Applies the same region-selection logic as the web app:
   - If Magic Volume is active (seed index present and used in the preset):
     - Uses the Magic Volume group definition as the primary inclusion set.
   - Else, if custom planes are present:
     - Finds the region that intersects the largest number of custom planes, then keeps or rejects that region according to `invertCrop`.
   - Else:
     - Uses the axis-aligned crop box + `invertCrop`.
4. Writes a new PLY containing only the cropped points.

> Note: Faces and other elements are not preserved; the output is a pure point cloud.

---

## GitHub Actions / CI Notes

This project is static (no build step required), so a minimal CI setup might:

- Run `python -m py_compile utils/crop_ply.py` to ensure the CLI script still parses.
- Optionally run a small sample crop:

```bash
python utils/crop_ply.py --ply path/to/sample.ply --preset presets/sample_preset.json --out /tmp/cropped_sample.ply
```

A GitHub Action workflow can then:

- Deploy `index.html` and static assets to GitHub Pages.
- Use the Pages URL (`https://refracta.github.io/point-cloud-cropper/index.html`) in integration tests or documentation.

